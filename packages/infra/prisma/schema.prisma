
generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Org {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
  meetings  Meeting[]
  tasks     Task[]
  decisions Decision[]

  @@map("orgs")
}

model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  emailVerified Boolean
  image         String?   @default("https://www.catstalkers.com/_next/static/media/bg-footer.1b0868cc.png")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
 
  role          UserRole  @default(MEMBER)

  orgId String
  org   Org    @relation(fields: [orgId], references: [id], onDelete: Cascade)

  sessions      Session[]
  accounts      Account[]
  assignedTasks Task[]     @relation("TaskAssignee")
  createdTasks  Task[]     @relation("TaskCreator")
  decisions     Decision[] @relation("DecisionAuthor")

  @@index([orgId])
  @@index([email])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @updatedAt

  @@map("verification")
}

enum UserRole {
  OWNER
  MEMBER
}

model Meeting {
  id          String        @id @default(uuid())
  title       String
  description String?
  status      MeetingStatus @default(SCHEDULED)
  scheduledAt DateTime?
  startedAt   DateTime?
  endedAt     DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  orgId String
  org   Org    @relation(fields: [orgId], references: [id], onDelete: Cascade)

  tasks     Task[]
  decisions Decision[]

  @@index([orgId])
  @@index([status])
  @@index([scheduledAt])
  @@map("meetings")
}

enum MeetingStatus {
  SCHEDULED
  LIVE
  ENDED
}

model Task {
  id          String     @id @default(uuid())
  title       String
  description String?
  status      TaskStatus @default(OPEN)
  dueAt       DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  orgId String
  org   Org    @relation(fields: [orgId], references: [id], onDelete: Cascade)

  meetingId String?
  meeting   Meeting? @relation(fields: [meetingId], references: [id], onDelete: SetNull)

  assigneeId String?
  assignee   User?   @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)

  creatorId String?
  creator   User?   @relation("TaskCreator", fields: [creatorId], references: [id], onDelete: SetNull)

  @@index([orgId])
  @@index([status])
  @@index([assigneeId])
  @@index([meetingId])
  @@map("tasks")
}

enum TaskStatus {
  OPEN
  DONE
}

model Decision {
  id          String   @id @default(uuid())
  decisionRef String   @default(uuid())
  version     Int      @default(1)
  title       String
  content     String
  rationale   String?
  evidence    String?
  createdAt   DateTime @default(now())

  orgId String
  org   Org    @relation(fields: [orgId], references: [id], onDelete: Cascade)

  meetingId String?
  meeting   Meeting? @relation(fields: [meetingId], references: [id], onDelete: SetNull)

  authorId String?
  author   User?   @relation("DecisionAuthor", fields: [authorId], references: [id], onDelete: SetNull)

  @@unique([decisionRef, version])
  @@index([orgId])
  @@index([decisionRef])
  @@index([meetingId])
  @@index([createdAt])
  @@map("decisions")
}
